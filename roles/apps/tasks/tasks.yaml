---
# tasks file for apps
- name: Install development environments
  block:
    - name: Install pycharm
      snap:
        name: pycharm-professional
        state: present
        classic: yes
      tags: pycharm

    - name: Install sublime text 3
      block:
        - name: Add GPG key
          apt_key:
            url: https://download.sublimetext.com/sublimehq-pub.gpg
            state: present
        - name: Make sure https sources work
          apt:
            name: apt-transport-https
            state: present
        - name: Add sublime to sources
          template:
            src: sublime-text.list
            dest: /etc/apt/sources.list.d/sublime-text.list
            owner: root
            group: root
            mode: u=rw,g=rw,o=r
        - name: Install sublime
          apt:
            name: sublime-text
            update_cache: yes
            state: latest
      tags: sublime
            
    - name: Install vscode (and insiders)
      block:
        - name: install vscode snap
          snap:
            name: code
            state: present
            classic: yes
        - name: install vscode-insiders snap
          snap:
            name: code-insiders
            state: present
            classic: yes
      tags: vscode


- name: Install Programming thingz
  block:
    - name: Install DockerCE
      block:
        - name: Uninstall old Docker
          apt:
            name:
              - docker
              - docker-engine
              - docker.io
              - containerd
              - runc
            state: absent
        - name: Add docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            id: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
            state: present
        - name: Add docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu  {{ ansible_distribution_release }} stable"
            state: present
            filename: docker
        - name: Install docker prerequisites
          apt:
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - gnupg-agent
              - software-properties-common
            state: latest
            update_cache: yes
        - name: Install docker CE
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
            state: latest
            update_cache: yes
        - name: Create docker group
          group:
            name: docker
            state: present
        - name: Add user to docker group
          user:
            name: "{{ ansible_user_id }}"
            groups: docker
            append: yes
      tags: docker

    - name: Install golang
      block:
        - name: Download go tarball
          get_url:
            url: https://dl.google.com/go/go1.14.2.linux-amd64.tar.gz
            dest: ~/Downloads/go1.14.2.linux-amd64.tar.gz
            checksum: sha256:6272d6e940ecb71ea5636ddb5fab3933e087c1356173c61f4a803895e947ebb3
          become: no
        - name: Extract go to /opt
          unarchive:
            src: ~{{ ansible_user_id }}/Downloads/go1.14.2.linux-amd64.tar.gz
            dest: /opt/
            creates: /opt/go
        - name: Add go binaries to PATH
          lineinfile:
            path: "{{ item }}"
            state: present
            line: "export PATH=$PATH:/opt/go/bin"
            regexp: '^export PATH=$PATH:/opt/go/bin$'
          loop:
            - /etc/zsh/zprofile
            - /etc/profile
        - name: Set up GOPATH
          file:
            path: ~/go
            state: directory
            mode: u=rwx,g=rx,o=
          become: no
        - name: add GOPATH to profile
          lineinfile:
            path: ~/.zshenv
            state: present
            line: "export GOPATH=~/go/bin"
          become: no
      tags: golang
    
    - name: Install singularity
      block:
        - name: Install singularity prerequesites
          apt:
            name:
              - build-essential
              - libssl-dev
              - uuid-dev
              - libgpgme11-dev
              - squashfs-tools
              - libseccomp-dev
              - pkg-config
            state: present
          become: yes
        - name: Download singularity 3.5.3
          get_url:
            url: https://github.com/sylabs/singularity/releases/download/v3.5.3/singularity-3.5.3.tar.gz
            dest: ~{{ ansible_user_id }}/Downloads/singularity-3.5.3.tar.gz
            checksum: sha256:0c76f1e3808bf4c10e92b17150314b2b816be79f8101be448a6e9d7a96c9e486
        - name: Ensure singularity exists in GOPATH
          file:
            path: ~/go/src/github.com/sylabs
            state: directory
            mode: u=rwx,g=rx,o=
        - name: Extract singularity to GOPATH
          unarchive:
            src: ~{{ ansible_user_id }}/Downloads/singularity-3.5.3.tar.gz
            dest: ~{{ ansible_user_id }}/go/src/github.com/sylabs
            creates: ~{{ ansible_user_id }}/go/src/github.com/sylabs/singularity
        - name: run mconfig
          command:
            argv:
              - ./mconfig
              - --prefix=/opt/singularity
            creates: ~{{ ansible_user_id }}/go/src/github.com/sylabs/singularity/builddir/Makefile
          args:
            chdir: ~{{ ansible_user_id }}/go/src/github.com/sylabs/singularity
        - name: Make singularity
          make:
            chdir: ~{{ ansible_user_id }}/go/src/github.com/sylabs/singularity/builddir
        - name: Install singularity
          make:
            chdir: ~{{ ansible_user_id }}/go/src/github.com/sylabs/singularity/builddir
            target: install
          become: yes
        - name: Add singularity to the PATH
          lineinfile:
            path: "{{ item }}"
            state: present
            line: "export PATH=$PATH:/opt/singularity/bin"
            regexp: '^export PATH=$PATH:/opt/singularity/bin$'
          become: yes
          loop:
            - /etc/zsh/zprofile
            - /etc/profile
      become: no
      tags: singularity

- name: Install communications software
  block:
    - name: Install Slack
      snap:
        name: slack
        state: present
        classic: yes
      tags: slack

- name: Install graphics programs
  block:
    - name: Install inkscape
      snap:
        name: inkscape
        state: present
        classic: no
      tags: inkscape
    - name: Install dia
      apt:
        name:
          - dia
        state: present
      tags: dia
    - name: Install graphviz
      apt:
        name:
          - graphviz
          - graphviz-dev
        state: present
      tags: graphviz
    - name: Install gimp
      snap:
        name: gimp
        state: present
        classic: no
      tags: gimp
